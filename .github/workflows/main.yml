name: VPS Setup
on: workflow_dispatch

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: Install & Configure SSH
      run: |
        sudo apt update -y
        sudo apt install -y openssh-server
        sudo systemctl enable ssh
        sudo systemctl start ssh
        echo "root:admin@123" | sudo chpasswd
        echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
        sudo service ssh restart
        echo "âœ… SSH user: root | pass: admin@123"
    
    - name: Install Graphical Interface (XFCE) and VNC
      run: |
        # ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ© XFCE (Ø®ÙÙŠÙØ© Ø§Ù„ÙˆØ²Ù†)
        sudo apt install -y xfce4 xfce4-goodies
        
        # ØªØ«Ø¨ÙŠØª Ø®Ø§Ø¯Ù… VNC
        sudo apt install -y tightvncserver
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙƒÙˆÙŠÙ† VNC
        mkdir -p ~/.vnc
        echo '#!/bin/bash
        xrdb $HOME/.Xresources
        startxfce4 &' > ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup
        
        # ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± VNC (admin@123)
        printf "admin@123\nadmin@123\nn\n" | vncpasswd
        
        # Ø¨Ø¯Ø¡ Ø®Ø§Ø¯Ù… VNC Ø¹Ù„Ù‰ Ù…Ù†ÙØ° 5901
        vncserver :1 -geometry 1280x800 -depth 24
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø¯Ù…Ø© systemd Ù„Ù€ VNC Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        echo '[Unit]
        Description=Remote Desktop Service (VNC)
        After=syslog.target network.target

        [Service]
        Type=forking
        User=root
        Group=root
        WorkingDirectory=/root
        PIDFile=/root/.vnc/%H:1.pid
        ExecStartPre=/bin/sh -c "/usr/bin/vncserver -kill :1 > /dev/null 2>&1 || :"
        ExecStart=/usr/bin/vncserver :1 -geometry 1280x800 -depth 24
        ExecStop=/usr/bin/vncserver -kill :1

        [Install]
        WantedBy=multi-user.target' | sudo tee /etc/systemd/system/vncserver@:1.service

        sudo systemctl daemon-reload
        sudo systemctl enable vncserver@:1.service
        sudo systemctl start vncserver@:1.service
        
        echo "âœ… VNC server installed - connect using IP:5901 with password: admin@123"
        
    - name: Configure Firewall (if enabled)
      run: |
        # ÙØªØ­ Ù…Ù†ÙØ° VNC Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ Ù†Ø´Ø·
        if sudo ufw status | grep -q "Status: active"; then
            sudo ufw allow 5901/tcp
            echo "âœ… Port 5901 (VNC) opened in firewall"
        fi
        
        # ÙØªØ­ Ù…Ù†ÙØ° RDP Ø¥Ø°Ø§ Ø±ØºØ¨Øª ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† VNC
        # sudo apt install -y xrdp
        # sudo ufw allow 3389/tcp
        
    - name: Display Connection Information
      run: |
        PUBLIC_IP=$(curl -s ifconfig.me)
        echo "=============================================="
        echo "âœ… VPS Setup Complete!"
        echo "ğŸ”— SSH Connection: ssh root@$PUBLIC_IP"
        echo "ğŸ–¥ï¸  VNC Connection: $PUBLIC_IP:5901"
        echo "ğŸ”‘ VNC Password: admin@123"
        echo "=============================================="
