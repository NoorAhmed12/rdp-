name: Windows 11 RDP with Max Resources
on:
  workflow_dispatch:
    # Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø®Ù„Ø§Øª Ù„ØªØ®ØµÙŠØµ Ø§Ù„Ø¬Ù„Ø³Ø© Ù‚Ø¨Ù„ ØªØ´ØºÙŠÙ„Ù‡Ø§
    inputs:
      runner_size:
        description: 'Choose VM Size (Resources)'
        required: true
        default: '2xlarge'
        type: choice
        options:
        - standard-2cores # 7GB RAM, 2 vCPUs (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©)
        - large           # 7GB RAM, 2 vCPUs
        - xl              # 14GB RAM, 4 vCPUs
        - 2xlarge         # 16GB RAM, 4 vCPUs (Ø£Ù‚ØµÙ‰ Ù…ÙˆØ§Ø±Ø¯)
      session_duration:
        description: 'Session Duration in Hours (Max 36 for 2xlarge, 72 for others)'
        required: true
        default: '6'
        type: choice
        options:
        - '6'
        - '12'
        - '24'
        - '36'
        - '60'
        - '72'

jobs:
  secure-rdp:
    # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø­Ø¯Ø« Ø¨ÙŠØ¦Ø© ÙˆÙŠÙ†Ø¯ÙˆØ² (Windows Server 2022) ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¬Ù… Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    runs-on: ${{ format('{0}-{1}', 'windows-latest', inputs.runner_size) }}
    
    # Ø­Ø³Ø§Ø¨ Ù…Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    timeout-minutes: ${{ fromJson(inputs.session_duration) * 60 }}

    steps:
      - name: Configure Core RDP Settings
        run: |
          # Enable Remote Desktop with more secure settings
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          # Enable Network Level Authentication for better security (can be disabled if needed)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 2 -Force
          
          # Configure Firewall for RDP
          netsh advfirewall firewall delete rule name="RDP-GitHub-Action" > $null
          netsh advfirewall firewall add rule name="RDP-GitHub-Action" dir=in action=allow protocol=TCP localport=3389 enable=yes
          
          # Restart the Remote Desktop service to ensure changes take effect
          Restart-Service -Name TermService -Force
          Write-Host "âœ… RDP settings configured successfully."

      - name: Create RDP User with Secure Password
        run: |
          # Generate a more secure and longer password
          Add-Type -AssemblyName System.Web
          $password = [System.Web.Security.Membership]::GeneratePassword(16, 4) # 16 chars, 4 non-alphanumeric
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Remove user if it already exists to avoid errors on re-run
          if (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name "RDP"
          }
          
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -FullName "Temporary RDP User"
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          
          # Store credentials securely and also output them as a single step
          $creds = "User: RDP | Password: $password"
          echo "RDP_CREDS=$creds" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          Write-Host "âœ… RDP user 'RDP' created successfully."

      - name: Install Latest Tailscale
        run: |
          # Always download the latest stable version
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force
          Write-Host "âœ… Tailscale installed successfully."

      - name: Establish Tailscale Connection
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          if (-not $env:TAILSCALE_AUTH_KEY) {
              Write-Error "âŒ TAILSCALE_AUTH_KEY secret is not set. Please add it to your repository secrets."
              exit 1
          }
          
          # Bring up Tailscale with a unique hostname and disable key expiry for the session
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=gh-runner-$env:GITHUB_RUN_ID --reset --accept-routes
          
          # Wait for Tailscale to assign an IP
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 20) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if (-not $tsIP) {
                  Write-Host "Waiting for Tailscale IP... (Attempt $($retries + 1)/20)"
                  Start-Sleep -Seconds 10
                  $retries++
              }
          }
          
          if (-not $tsIP) {
              Write-Error "âŒ Tailscale IP not assigned after multiple attempts. Exiting."
              exit 1
          }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "âœ… Tailscale connected successfully. IP: $tsIP"

      - name: Verify RDP Accessibility
        run: |
          Write-Host "Verifying RDP port accessibility on $env:TAILSCALE_IP..."
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "âŒ TCP connection to RDP port 3389 failed. Firewall or service might be misconfigured."
              exit 1
          }
          Write-Host "âœ… TCP connectivity to RDP port successful!"

      - name: Display System Information
        run: |
          Write-Host "`n=== SYSTEM INFORMATION ==="
          $osInfo = Get-ComputerInfo | Select-Object OsName, OsVersion, OsArchitecture
          $cpuInfo = Get-CimInstance -ClassName Win32_Processor | Select-Object Name, NumberOfCores
          $memInfo = Get-CimInstance -ClassName Win32_ComputerSystem | Select-Object TotalPhysicalMemory
          $freeSpace = Get-PSDrive -Name C | Select-Object @{Name="Free(GB)";Expression={[math]::Round($_.Free/1GB,2)}}
          
          Write-Host "OS: $($osInfo.OsName)"
          Write-Host "Version: $($osInfo.OsVersion)"
          Write-Host "Architecture: $($osInfo.OsArchitecture)"
          Write-Host "CPU: $($cpuInfo.Name)"
          Write-Host "Cores: $($cpuInfo.NumberOfCores)"
          Write-Host "Total RAM: $([math]::Round($memInfo.TotalPhysicalMemory / 1GB, 2)) GB"
          Write-Host "Free Disk Space (C:): $($freeSpace.'Free(GB)') GB"
          Write-Host "=========================`n"

      # Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„ØªÙŠ ØªØ¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØªØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù„Ø³Ø©
      - name: Maintain Connection and Display RDP Info
        run: |
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø´ÙƒÙ„ Ù†Ø¸ÙŠÙ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±
          $password = $env:RDP_PASSWORD
          
          # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ø§ØªØµØ§Ù„
          Write-Host "`nğŸ‰ RDP SESSION IS READY! ğŸ‰" -ForegroundColor Green
          Write-Host "================================================" -ForegroundColor Yellow
          Write-Host "   ğŸ‘¤ Username: RDP" -ForegroundColor White
          Write-Host "   ğŸ”‘ Password: $password" -ForegroundColor White
          Write-Host "   ğŸŒ Address: $($env:TAILSCALE_IP)" -ForegroundColor White
          Write-Host "   â±ï¸  Duration: ${{ inputs.session_duration }} Hours" -ForegroundColor White
          Write-Host "================================================" -ForegroundColor Yellow
          Write-Host "â„¹ï¸  Use any RDP client to connect. This session will automatically terminate after the specified duration or if you cancel the workflow." -ForegroundColor Cyan
          Write-Host "`n"
          
          # Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ± Ø¹Ù…Ù„
          $endTime = (Get-Date).AddHours([int]${{ inputs.session_duration }})
          while ($true) {
              $remainingTime = $endTime - (Get-Date)
              if ($remainingTime.TotalSeconds -le 0) {
                  Write-Host "â° Session duration has ended. Terminating workflow." -ForegroundColor Red
                  exit 0
              }
              Write-Host "[$(Get-Date)] RDP Active - Time remaining: $([math]::Floor($remainingTime.TotalHours))h $($remainingTime.Minutes)m $($remainingTime.Seconds)s - Use 'Cancel workflow' to terminate manually."
              Start-Sleep -Seconds 60
          }
