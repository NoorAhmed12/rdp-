name: macOS Remote Access

on:
  workflow_dispatch:

jobs:
  secure-remote:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Remote Desktop (RDP)
        run: |
          sudo systemsetup -setremotelogin on
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement.plist UseRemoteManagement -bool YES
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -allowAccessFor -allUsers -privs -all

      - name: Configure Firewall for RDP
        run: |
          echo 'pass in proto tcp from any to any port 3389' | sudo pfctl -ef -
          sudo pfctl -e || true

      - name: Create User with Secure Password
        run: |
          PASSWORD="Yaso1212"
          USERNAME="macuser"
          
          if ! id "$USERNAME" &>/dev/null; then
              sudo sysadminctl -addUser "$USERNAME" -password "$PASSWORD" -admin
              echo "User created: $USERNAME"
          else
              echo "$PASSWORD" | sudo dscl . -passwd "/Users/$USERNAME"
              echo "Password updated for: $USERNAME"
          fi
          
          echo "REMOTE_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "REMOTE_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          # Fixed package name (corrected spelling)
          TS_URL="https://pkgs.tailscale.com/stable/tailscale-macos-latest.pkg"
          INSTALLER_PATH="/tmp/tailscale.pkg"  # Corrected path
          
          curl -o "$INSTALLER_PATH" "$TS_URL"
          
          # Verify download was successful
          if [ ! -f "$INSTALLER_PATH" ]; then
              echo "Error: Failed to download Tailscale package"
              exit 1
          fi
          
          sudo installer -pkg "$INSTALLER_PATH" -target /
          rm -f "$INSTALLER_PATH"

      - name: Establish Tailscale Connection
        run: |
          sudo /Applications/Tailscale.app/Contents/MacOS/Tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-mac-runner-$GITHUB_RUN_ID
          
          TS_IP=""
          RETRIES=0
          while [ -z "$TS_IP" ] && [ $RETRIES -lt 10 ]; do
              TS_IP=$(/Applications/Tailscale.app/Contents/MacOS/Tailscale ip -4)
              sleep 5
              RETRIES=$((RETRIES+1))
          done
          
          if [ -z "$TS_IP" ]; then
              echo "Failed to get Tailscale IP"
              exit 1
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
      
      - name: Verify RDP Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          
          # Install netcat if not present
          if ! command -v nc &> /dev/null; then
              brew install netcat || true
          fi
          
          if nc -z -w 5 "$TAILSCALE_IP" 3389; then
              echo "RDP connection successful!"
          else
              echo "Warning: RDP connection failed"
          fi

      - name: Maintain Connection
        run: |
          echo "=== Remote Access Details ==="
          echo "Address: $TAILSCALE_IP"
          echo "System: macOS"
          echo "Protocol: RDP (port 3389)"
          echo "Username: $REMOTE_USERNAME"
          echo "Password: $REMOTE_PASSWORD"
          echo "============================="
          
          # Keep the runner active
          while true; do
              echo "[$(date)] Connection active - Use Ctrl+C in workflow to terminate"
              sleep 300
          done
