name: VPS Setup
on: workflow_dispatch

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: Install & Configure SSH
      run: |
        sudo apt update -y
        sudo apt install -y openssh-server
        sudo systemctl enable ssh
        sudo systemctl start ssh
        echo "root:admin12345" | sudo chpasswd  # Changed to 8+ chars
        echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
        sudo service ssh restart
        echo "âœ… SSH user: root | pass: admin12345"
    
    - name: Switch to root user
      run: |
        # Ø³Ù†Ø¹Ù…Ù„ ÙƒÙ€ root Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        sudo -i
    
    - name: Install Graphical Interface (XFCE)
      run: |
        # ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ© XFCE
        apt update -y
        apt install -y xfce4 xfce4-goodies xfce4-terminal firefox
        
        echo "âœ… XFCE desktop environment installed"
    
    - name: Install and Configure VNC Server
      run: |
        # ØªØ«Ø¨ÙŠØª VNC Server
        apt install -y tightvncserver
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙƒÙˆÙŠÙ† VNC
        mkdir -p ~/.vnc
        echo '#!/bin/bash
        xrdb $HOME/.Xresources
        startxfce4 &' > ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup
        
        # ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± VNC (8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)
        printf "admin12345\nadmin12345\nn\n" | vncpasswd
        
        echo "âœ… VNC server configured"
    
    - name: Create VNC Systemd Service
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø¯Ù…Ø© systemd Ù„Ù€ VNC
        cat > /etc/systemd/system/vncserver.service << 'EOF'
[Unit]
Description=Remote Desktop VNC Service
After=syslog.target network.target

[Service]
Type=forking
User=root
WorkingDirectory=/root
PIDFile=/root/.vnc/%H:1.pid
ExecStartPre=-/usr/bin/vncserver -kill :1 > /dev/null 2>&1
ExecStart=/usr/bin/vncserver -depth 24 -geometry 1280x800 :1
ExecStop=/usr/bin/vncserver -kill :1

[Install]
WantedBy=multi-user.target
EOF
        
        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
        systemctl daemon-reload
        systemctl enable vncserver.service
        
        echo "âœ… VNC systemd service configured"
    
    - name: Start VNC Server manually
      run: |
        # Ø¨Ø¯Ø¡ VNC ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„Ù‡
        vncserver :1 -geometry 1280x800 -depth 24
        echo "âœ… VNC server started manually on port 5901"
    
    - name: Install Alternative RDP Server (xRDP)
      run: |
        # ØªØ«Ø¨ÙŠØª Ø®Ø§Ø¯Ù… RDP ÙƒØ¨Ø¯ÙŠÙ„
        apt install -y xrdp
        systemctl enable xrdp
        systemctl start xrdp
        
        # Ø¥Ø¶Ø§ÙØ© ØªÙƒÙˆÙŠÙ† Ù„Ù„Ø¬Ù„Ø³Ø§Øª
        echo xfce4-session > ~/.xsession
        systemctl restart xrdp
        
        echo "âœ… xRDP server installed - connect using RDP client to port 3389"
    
    - name: Configure Firewall
      run: |
        # ØªØ«Ø¨ÙŠØª ÙˆØªÙƒÙˆÙŠÙ† Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ
        apt install -y ufw
        ufw allow ssh
        ufw allow 3389/tcp  # RDP
        ufw allow 5901/tcp  # VNC
        echo "y" | ufw enable
        echo "âœ… Firewall configured with open ports for SSH, RDP and VNC"
    
    - name: Display Connection Information
      run: |
        PUBLIC_IP=$(curl -s ifconfig.me)
        echo "=============================================="
        echo "âœ… VPS Setup Complete!"
        echo "ğŸ”— SSH Connection: ssh root@$PUBLIC_IP"
        echo "ğŸ”‘ SSH Password: admin12345"
        echo "ğŸ–¥ï¸  VNC Connection: $PUBLIC_IP:5901"
        echo "ğŸ”‘ VNC Password: admin12345"
        echo "ğŸ”µ RDP Connection: $PUBLIC_IP:3389"
        echo "ğŸ”‘ RDP Username: root | Password: admin12345"
        echo "=============================================="
