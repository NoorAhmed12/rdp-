name: macOS Remote Access

on:
  workflow_dispatch:

jobs:
  secure-remote:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Enable Screen Sharing (VNC)
        run: |
          # تمكين مشاركة الشاشة (VNC)
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          
          # تكوين إعدادات VNC
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false
          
          # السماح بالوصول لكافة المستخدمين (لأغراض الاختبار)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -allowAccessFor -allUsers -privs -all -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw "Yaso1212"

      - name: Configure Firewall
        run: |
          # فتح منفذ VNC (5900)
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --addport 5900 --tcp --allow
          
          # إعادة تحميل إعدادات الجدار الناري
          sudo pkill -HUP socketfilterfw

      - name: Create User with Static Credentials
        run: |
          # بيانات الاعتماد الثابتة
          USERNAME="macuser"
          PASSWORD="Yaso1212" # يرجى تغيير هذه كلمة المرور لشيء أكثر أماناً
          
          # إنشاء المستخدم إذا لم يكن موجوداً
          if ! id "$USERNAME" &>/dev/null; then
              sudo sysadminctl -addUser "$USERNAME" -password "$PASSWORD" -admin
              echo "تم إنشاء المستخدم الجديد: $USERNAME"
          else
              # تحديث كلمة مرور المستخدم الموجود
              sudo dscl . -passwd "/Users/$USERNAME" "$PASSWORD"
              echo "تم تحديث كلمة مرور المستخدم الموجود: $USERNAME"
          fi
          
          # تخزين بيانات الاعتماد في متغيرات البيئة
          echo "REMOTE_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "REMOTE_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          # تحميل وتثبيت Tailscale
          TS_URL="https://pkgs.tailscale.com/stable/tailscale-macos-1.82.0.pkg"
          INSTALLER_PATH="/tmp/tailscale.pkg"
          
          curl -o "$INSTALLER_PATH" "$TS_URL"
          sudo installer -pkg "$INSTALLER_PATH" -target /
          rm -f "$INSTALLER_PATH"

      - name: Establish Tailscale Connection
        run: |
          # تشغيل Tailscale بمفتاح المصادقة
          sudo /Applications/Tailscale.app/Contents/MacOS/Tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-mac-runner-$GITHUB_RUN_ID
          
          # الانتظار حتى يتم تعيين IP
          TS_IP=""
          RETRIES=0
          while [ -z "$TS_IP" ] && [ $RETRIES -lt 10 ]; do
              TS_IP=$(/Applications/Tailscale.app/Contents/MacOS/Tailscale ip -4)
              sleep 5
              RETRIES=$((RETRIES+1))
          done
          
          if [ -z "$TS_IP" ]; then
              echo "لم يتم تعيين عنوان IP من Tailscale. الخروج."
              exit 1
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
      
      - name: Verify Remote Accessibility
        run: |
          echo "عنوان Tailscale IP: $TAILSCALE_IP"
          
          # اختبار الاتصال على منفذ VNC 5900
          if nc -z -w 5 "$TAILSCALE_IP" 5900; then
              echo "تم الاتصال TCP على منفذ VNC 5900 بنجاح!"
          else
              echo "تحذير: فشل الاتصال TCP على منفذ VNC 5900"
          fi

      - name: Maintain Connection
        run: |
          echo ""
          echo "=== الوصول عن بعد ==="
          echo "العنوان: $TAILSCALE_IP"
          echo "النظام: macOS"
          echo "البروتوكول: VNC (منفذ 5900)"
          echo "اسم المستخدم: $REMOTE_USERNAME"
          echo "كلمة المرور: $REMOTE_PASSWORD"
          echo "كلمة مرور VNC: $REMOTE_PASSWORD"
          echo "=================="
          echo ""
          
          # إبقاء العدّاد نشطاً
          while true; do
              echo "[$(date)] الاتصال نشط - استخدم Ctrl+C في سير العمل للإنهاء"
              sleep 300
          done
