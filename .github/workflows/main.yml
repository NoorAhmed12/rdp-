name: VPS Setup
on: workflow_dispatch

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: Install & Configure SSH
      run: |
        sudo apt update -y
        sudo apt install -y openssh-server
        sudo systemctl enable ssh
        sudo systemctl start ssh
        echo "root:admin@123" | sudo chpasswd
        echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
        sudo service ssh restart
        echo "✅ SSH user: root | pass: admin@123"
    
    - name: Install Graphical Interface (XFCE)
      run: |
        # تثبيت الواجهة الرسومية XFCE
        sudo apt install -y xfce4 xfce4-goodies xfce4-terminal
        
        # تثبيت متصفح الويب وأدوات مساعدة
        sudo apt install -y firefox
        
        echo "✅ XFCE desktop environment installed"
    
    - name: Install and Configure VNC Server
      run: |
        # تثبيت VNC Server
        sudo apt install -y tightvncserver
        
        # إعداد تكوين VNC
        mkdir -p ~/.vnc
        echo '#!/bin/bash
        xrdb $HOME/.Xresources
        startxfce4 &' > ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup
        
        # تعيين كلمة مرور VNC (admin@123)
        printf "admin@123\nadmin@123\nn\n" | vncpasswd
        
        # بدء خادم VNC على منفذ 5901
        vncserver :1 -geometry 1280x800 -depth 24
        
        echo "✅ VNC server installed - connect using IP:5901 with password: admin@123"
    
    - name: Create VNC Systemd Service (Fixed)
      run: |
        # إنشاء خدمة systemd لـ VNC
        echo '[Unit]
Description=TightVNC Server
After=syslog.target network.target

[Service]
Type=forking
User=root
PAMName=login
PIDFile=/root/.vnc/%H:1.pid
ExecStartPre=-/usr/bin/vncserver -kill :1 > /dev/null 2>&1
ExecStart=/usr/bin/vncserver -depth 24 -geometry 1280x800 :1
ExecStop=/usr/bin/vncserver -kill :1

[Install]
WantedBy=multi-user.target' | sudo tee /etc/systemd/system/vncserver@.service

        # إعادة تحميل وتشغيل الخدمة
        sudo systemctl daemon-reload
        sudo systemctl enable vncserver@1.service
        sudo systemctl start vncserver@1.service
        
        # التحقق من حالة الخدمة
        sudo systemctl status vncserver@1.service
        
        echo "✅ VNC systemd service configured"
    
    - name: Install Alternative RDP Server (xRDP)
      run: |
        # تثبيت خادم RDP كبديل
        sudo apt install -y xrdp
        sudo systemctl enable xrdp
        sudo systemctl start xrdp
        
        # إضافة تكوين للجلسات
        echo xfce4-session > ~/.xsession
        sudo systemctl restart xrdp
        
        # فتح منفذ RDP إذا كان الجدار الناري نشط
        if sudo ufw status | grep -q "Status: active"; then
            sudo ufw allow 3389/tcp
            echo "✅ Port 3389 (RDP) opened in firewall"
        fi
        
        echo "✅ xRDP server installed - connect using RDP client to port 3389"
    
    - name: Configure Firewall
      run: |
        # فتح منافذ VNC وRDP إذا كان الجدار الناري نشط
        if sudo ufw status | grep -q "Status: active"; then
            sudo ufw allow 5901/tcp
            echo "✅ Port 5901 (VNC) opened in firewall"
        fi
    
    - name: Display Connection Information
      run: |
        PUBLIC_IP=$(curl -s ifconfig.me)
        echo "=============================================="
        echo "✅ VPS Setup Complete!"
        echo "🔗 SSH Connection: ssh root@$PUBLIC_IP"
        echo "🖥️  VNC Connection: $PUBLIC_IP:5901 (Password: admin@123)"
        echo "🔵 RDP Connection: $PUBLIC_IP:3389"
        echo "=============================================="
